create schema if not exists supplychaindb;
Use supplychaindb;

-- DataBase Design for modeling Stage
-- To be ready for ETL 


CREATE TABLE calendar (
    date_value DATE PRIMARY KEY,
    year INT,
    month INT,
    day INT,
    quarter INT
);

-- ------------------------------------


-- Create Category Table
CREATE TABLE dimcategory (
    categoryKey INT PRIMARY KEY AUTO_INCREMENT,
    categoryName VARCHAR(50) NOT NULL
);

-- -------------------------------

CREATE TABLE dimcustomer (
    customerID VARCHAR(50) PRIMARY KEY,
    ZIP_Code INT,
    City VARCHAR(50) NOT NULL,
    State VARCHAR(10) NOT NULL
);

-- --------------------------------
set FOREIGN_KEY_CHECKS = 0;
drop table factorders;
drop table dimpayment;
CREATE TABLE dimpayment (
    payment_sk INT PRIMARY KEY AUTO_INCREMENT,
    paymentType VARCHAR(50) NOT NULL,
    paymentInstallments INT,
    payment_code VARCHAR(50)
);

-- ----------------------------------
-- Create dimProduct Table


create table dimproduct (
productID varchar(50) primary key,
categoryKey INT not null ,
    Weight_g DECIMAL(10 , 2 ),
    Length_cm DECIMAL(10 , 2 ),
    Height_cm DECIMAL(10 , 2 ),
    Width_cm DECIMAL(10 , 2 ),
         FOREIGN KEY (CategoryKey)
        REFERENCES DimCategory (CategoryKey)  -- can’t assign a category that doesn’t exist in category dimension.

);

-- --------------------------------
-- create dimSeller Table

create table dimseller (
SellerId varchar(50) primary key
);

-- ---------------------------------

-- create factOrders Table 

create table factOrders(
OrderId varchar(50) primary key ,
OrderStatus varchar(50) NOT NULL , 
PurchaseDate date NOT NULL,
ApprovedDate date NOT NULL,
EstimatedDeliveryDate date NOT NULL,
DeliveredDate date NOT NULL,
CustomerId varchar(50) NOT NULL,
ProductId varchar(50) NOT NULL,
SellerId varchar(50) NOT NULL,
payment_sk int not null,                  
Price Decimal(10,2) not null,
ShippingCharges Decimal(10,2) not null,

FOREIGN KEY (CustomerId) REFERENCES dimCustomer(CustomerId),
FOREIGN KEY (ProductId) REFERENCES dimProduct(ProductId),
FOREIGN KEY (SellerId) REFERENCES dimSeller(SellerId),
FOREIGN KEY (payment_sk) REFERENCES dimpayment(payment_sk)
);

-- START OF ETL 
-- FIRST INSERT VALUES IN CALENDAR TABLE

SET @StartDate = '2016-09-04';
SET @EndDate   = '2018-10-25';


-- Generate dates and insert them
INSERT INTO calendar (date_value, year, month, day, quarter)
SELECT 
     date_value,
    YEAR(date_value),
    MONTH(date_value),
    DAY(date_value),
    QUARTER(date_value)
FROM (
    WITH RECURSIVE CalendarCTE AS (
        SELECT @StartDate AS date_value
        UNION ALL
        SELECT DATE_ADD(date_value, INTERVAL 1 DAY)
        FROM CalendarCTE
        WHERE DATE_ADD(date_value, INTERVAL 1 DAY) <= @EndDate
    )
    SELECT date_value FROM CalendarCTE
) AS temp;

-- insert values in category table
truncate dimcategory;
INSERT INTO dimcategory(categoryName)
select distinct if(product_category_name='', 'Unknown',product_category_name)  -- Handle blanks
from stagingtable;
select * from dimcategory;

-- ------------------------------

-- insert values in product table
-- Truncate dimproduct;
Insert into dimproduct(productID,categoryKey,weight_g,length_cm,height_cm,width_cm)
select
distinct product_id,
c.categoryKey,
product_weight_g,
product_length_cm,
product_height_cm,
product_width_cm
from stagingtable as s
join dimcategory as c on if(product_category_name='', 'Unknown',product_category_name) = c.categoryName ;

-- select * from dimproduct;

-- ------------------------------
-- Insert values in dim seller

Insert into dimseller ( SellerId )
select distinct seller_id from stagingtable;

-- -----------------------------
-- Insert values in dimcustomer

Insert into dimcustomer(customerID,ZIP_Code,City,State)
Select distinct customer_id , customer_zip_code_prefix , customer_city ,customer_state
from stagingtable;


-- ------------------------------------------
-- create trigger for payment_code (combinarion deom the first 2 letters of payment tyoe and installments )
CREATE TRIGGER payment_code
BEFORE INSERT ON dimpayment
FOR EACH ROW
SET NEW.payment_code = CONCAT(UPPER(LEFT(NEW.paymentType, 2)), '_', NEW.paymentInstallments);

-- -- Insert values in dimpayment
 
 Insert into dimpayment(paymentType,paymentInstallments)
 select distinct   payment_type,
  IF(
    payment_installments LIKE '%/0/%'
     or payment_installments is null, 0,
    DAY(STR_TO_DATE(payment_installments, '%m/%d/%Y %H:%i'))
  ) AS payment_installments
 from stagingtable
 group by payment_type,payment_installments;

-- -----------------------------------------
-- Insert values in factorders 


Insert into factorders(OrderId, OrderStatus,
 PurchaseDate, ApprovedDate, EstimatedDeliveryDate, DeliveredDate, 
 CustomerId, ProductId, SellerId, payment_sk, Price, ShippingCharges)
select order_id,order_status,
COALESCE(
        date(str_to_date(NULLIF(order_purchase_timestamp, ''), '%m/%d/%Y %H:%i')),
        '1900-01-01' -- Default date for NULL
    ) as PurchaseTime,
    
    COALESCE(
        date(str_to_date(NULLIF(order_approved_at, ''), '%m/%d/%Y %H:%i')),
        '1900-01-01' -- Default date for NULL
    ) as ApprovedAt,
    
    COALESCE(
        date(str_to_date(NULLIF(order_estimated_delivery_date, ''), '%m/%d/%Y %H:%i')),
        '1900-01-01' -- Default date for NULL
    ) as EstimatedDeliveryTime,
    
    COALESCE(
        date(str_to_date(NULLIF(order_delivered_timestamp, ''), '%m/%d/%Y %H:%i')),
        '1900-01-01' -- Default date for NULL
    ) as deliveredTime,
customer_id,
product_id,
seller_id,
dp.payment_sk,
price,
shipping_charges
from stagingtable st
join dimcustomer dc on dc.customerID = st.customer_id
join dimseller ds on ds.SellerId = st.seller_id
join dimpayment dp on dp.paymentType = st.payment_type and dp.paymentInstallments=IF(
        st.payment_installments LIKE '%/0/%' OR st.payment_installments IS NULL, 
        0, 
        DAY(STR_TO_DATE(st.payment_installments, '%m/%d/%Y %H:%i'))
    );

ALTER TABLE factOrders
MODIFY ApprovedDate date NULL,
MODIFY DeliveredDate date NULL,
MODIFY EstimatedDeliveryDate date NULL;

-- 1. Drop the current primary key
ALTER TABLE factOrders
DROP PRIMARY KEY;

-- 2. Add the correct, composite primary key
ALTER TABLE factOrders
ADD PRIMARY KEY (OrderId, ProductId);




